RLPx Encryption\(RLPx加密\)

每一个节点会开启两个同样的端口，一个是UDP端口，用来节点发现，一个是TCP端口，用来承载业务数据。 UDP的端口和TCP的端口的端口号是同样的。 这样只要通过UDP发现了端口，就等于可以用TCP来连接到对应的端口。

RLPx协议就定义了TCP链接的加密过程。

RLPx使用了\(Perfect Forward Secrecy\), 简单来说。 链接的两方生成生成随机的私钥，通过随机的私钥得到公钥。 然后双方交换各自的公钥， 这样双方都可以通过自己随机的私钥和对方的公钥来生成一个同样的共享密钥\(shared-secret\)。后续的通讯使用这个共享密钥作为对称加密算法的密钥。 这样来说。如果有一天一方的私钥被泄露，也只会影响泄露之后的消息的安全性， 对于之前的通讯是安全的\(因为通讯的密钥是随机生成的，用完后就消失了\)。

![](/assets/ethereum-p2pnet-rlpx.png)

 在底层的golang的网络通信类库Tcp socket接口与 上层的核心协议之间， 存在一个中间层

被称之为transport， 这一层的主要工作就是对于上层消息的编解码/加解密从而使得通信高效而安全。

在thereum 中 这一层的实现是通过rlpx 协议来完成。

Rlpx 协议详解

rlpx 协议之中又可以分为3个层次：

1. 首先是对上层协议的原始消息的编解码.编解码的协议是RLP。

主要目的是使得数据类型在传输中编解码的结果与平台无关.

1. 其次是针对RLP编解码的结果进行压缩或者解压缩。这里采用的是snappy压缩算

2. ECIES\(Elliptic Curve Integrated Encryption Scheme\) 加/解密算法

对于压缩后的数据进行加密

或者对于网络栈上传的数据进行解密而后解压缩。

ECIES 算法是一种基于椭圆曲线的集成了密钥交换+对称加密+消息验证码的一套算法体系。

